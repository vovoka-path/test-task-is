"""
–ì–ª–∞–≤–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –¥—ã–º–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–æ–≤.

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç –±–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:
- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ Chunk
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML-–æ—Ç—á–µ—Ç–∞ —Å –ø–æ–º–æ—â—å—é —Ñ—É–Ω–∫—Ü–∏–∏ generate_report
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
"""

import logging
from typing import List
from src.data_models import Chunk
from src.report_generator import generate_report


def create_test_chunks() -> List[Chunk]:
    """
    –°–æ–∑–¥–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ Chunk –¥–ª—è –¥—ã–º–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    
    –§—É–Ω–∫—Ü–∏—è –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞–µ—Ç 3 —Ç–µ—Å—Ç–æ–≤—ã—Ö —á–∞–Ω–∫–∞ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏,
    –∏–º–∏—Ç–∏—Ä—É—é—â–∏–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞.
    
    Returns:
        List[Chunk]: –°–ø–∏—Å–æ–∫ –∏–∑ 3 —Ç–µ—Å—Ç–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ Chunk
        
    Example:
        >>> chunks = create_test_chunks()
        >>> len(chunks)
        3
    """
    logger = logging.getLogger(__name__)
    logger.info("–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —á–∞–Ω–∫–æ–≤ –¥–ª—è –¥—ã–º–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —á–∞–Ω–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∑–∞–¥–∞–Ω–∏—é
    test_chunks = [
        Chunk(
            content="–¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –ø–µ—Ä–≤–æ–≥–æ —á–∞–Ω–∫–∞",
            metadata={
                "source_document": "test_doc.docx",
                "context": "–ì–ª–∞–≤–∞ 1. –í–≤–µ–¥–µ–Ω–∏–µ"
            }
        ),
        Chunk(
            content="–¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –≤—Ç–æ—Ä–æ–≥–æ —á–∞–Ω–∫–∞",
            metadata={
                "source_document": "test_doc.docx",
                "context": "–ì–ª–∞–≤–∞ 2. –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å"
            }
        ),
        Chunk(
            content="–¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Ç—Ä–µ—Ç—å–µ–≥–æ —á–∞–Ω–∫–∞",
            metadata={
                "source_document": "test_doc.docx",
                "context": "–ì–ª–∞–≤–∞ 3. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ"
            }
        )
    ]
    
    logger.info(f"–°–æ–∑–¥–∞–Ω–æ {len(test_chunks)} —Ç–µ—Å—Ç–æ–≤—ã—Ö —á–∞–Ω–∫–æ–≤")
    
    # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —á–∞–Ω–∫–∞—Ö –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    for i, chunk in enumerate(test_chunks, 1):
        logger.debug(f"–ß–∞–Ω–∫ {i}: –∫–æ–Ω—Ç–µ–∫—Å—Ç='{chunk.metadata['context']}', "
                    f"—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ='{chunk.content[:30]}...'")
    
    return test_chunks


def run_smoke_test() -> None:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –¥—ã–º–æ–≤–æ–π —Ç–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–æ–≤.
    
    –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
    1. –°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ–±—ä–µ–∫—Ç—ã Chunk)
    2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HTML-–æ—Ç—á–µ—Ç —Å –ø–æ–º–æ—â—å—é Jinja2 —à–∞–±–ª–æ–Ω–∞
    3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    4. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏
    
    Raises:
        Exception: –ü—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥—ã–º–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∞
    """
    logger = logging.getLogger(__name__)
    
    try:
        logger.info("=" * 60)
        logger.info("–ó–ê–ü–£–°–ö –î–´–ú–û–í–û–ì–û –¢–ï–°–¢–ê –°–ò–°–¢–ï–ú–´ –ì–ï–ù–ï–†–ê–¶–ò–ò –û–¢–ß–ï–¢–û–í")
        logger.info("=" * 60)
        
        # –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        logger.info("1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...")
        test_chunks = create_test_chunks()
        logger.info(f"   –°–æ–∑–¥–∞–Ω–æ {len(test_chunks)} —Ç–µ—Å—Ç–æ–≤—ã—Ö —á–∞–Ω–∫–æ–≤")
        
        # –®–∞–≥ 2: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º
        logger.info("2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º...")
        template_path = "templates/report_template.html"
        output_path = "output/report.html"
        logger.info(f"   –®–∞–±–ª–æ–Ω: {template_path}")
        logger.info(f"   –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: {output_path}")
        
        # –®–∞–≥ 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
        logger.info("3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML-–æ—Ç—á–µ—Ç–∞...")
        generate_report(
            chunks=test_chunks,
            template_path=template_path,
            output_path=output_path
        )
        
        # –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        logger.info("4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...")
        
        import os
        if os.path.exists(output_path):
            file_size = os.path.getsize(output_path)
            logger.info(f"   ‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: {output_path}")
            logger.info(f"   üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {file_size:,} –±–∞–π—Ç")
            
            # –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ —Ñ–∞–π–ª–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            try:
                with open(output_path, 'r', encoding='utf-8') as f:
                    first_lines = f.read(200)
                logger.info(f"   üìù –ù–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞: {first_lines[:100]}...")
            except Exception as e:
                logger.warning(f"   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞: {e}")
        else:
            error_msg = f"–í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {output_path}"
            logger.error(error_msg)
            raise FileNotFoundError(error_msg)
        
        logger.info("=" * 60)
        logger.info("–î–´–ú–û–í–û–ô –¢–ï–°–¢ –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù!")
        logger.info("=" * 60)
        logger.info(f"HTML-–æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª: {output_path}")
        logger.info("–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞")
        
    except FileNotFoundError as e:
        logger.error(f"‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω - {e}")
        raise
        
    except Exception as e:
        logger.error(f"‚ùå –ù–ï–ü–†–ï–î–í–ò–î–ï–ù–ù–ê–Ø –û–®–ò–ë–ö–ê: {e}")
        raise Exception(f"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥—ã–º–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∞: {e}") from e


def main() -> None:
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥—ã–º–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    
    –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥—ã–º–æ–≤–æ–π —Ç–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã.
    –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏ –≤—ã–≤–æ–¥–∏—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    
    try:
        run_smoke_test()
        print("\nüéâ –î—ã–º–æ–≤–æ–π —Ç–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!")
        print("üìÅ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª output/report.html –≤ –±—Ä–∞—É–∑–µ—Ä–µ")
        
    except FileNotFoundError as e:
        print(f"\n‚ùå –û–®–ò–ë–ö–ê –§–ê–ô–õ–ê: {e}")
        print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª templates/report_template.html —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
        
    except Exception as e:
        print(f"\n‚ùå –û–®–ò–ë–ö–ê –°–ò–°–¢–ï–ú–´: {e}")
        print("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π")


if __name__ == "__main__":
    main()